<style>
/**
 * LAPORTE Brand Theme for BookStack
 * Version: 2.0 - Fixed readability and dark mode
 *
 * Official LAPORTE Color Palette:
 * - Primary Dark Blue: #00263b
 * - Primary Dark (hover): #001a28
 * - Accent Golden Yellow: #E9B52D
 * - Text Dark: #333333
 * - Text Medium: #555555
 * - Text Muted: #666666
 * - Light Blue Background: #eef6f9
 * - Light Blue Hover: #dbeef4
 * - Border: #c8dbe3
 * - White: #ffffff
 */

:root {
    /* LAPORTE Brand Colors */
    --color-primary: #00263b;
    --color-primary-dark: #001a28;
    --color-accent: #E9B52D;
    --color-text: #333333;
    --color-text-medium: #555555;
    --color-text-muted: #666666;
    --color-bg-light: #eef6f9;
    --color-bg-hover: #dbeef4;
    --color-border: #c8dbe3;
    --color-white: #ffffff;
}

/* ============================================
   GENERAL TEXT IMPROVEMENTS
   ============================================ */

/* Ensure body text is readable with robust font fallback stack */
body {
    color: #333333 !important;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
}

/* Entity descriptions */
.entity-list-item-description {
    color: #555555 !important;
}

/* Muted text should still be readable */
.text-muted,
.meta,
small {
    color: #666666 !important;
}

/* ============================================
   HEADER & NAVIGATION
   ============================================ */

/* Main header bar */
header#header {
    background-color: var(--color-primary) !important;
    border-bottom: 3px solid var(--color-accent) !important;
    position: relative !important;
    z-index: 1000 !important;
}

/* Header links and text */
header#header a,
header#header .header-links a {
    color: var(--color-white) !important;
}

header#header a:hover,
header#header .header-links a:hover {
    color: var(--color-accent) !important;
}

/* Logo text */
.header-logo a {
    color: var(--color-white) !important;
}

/* Search bar in header */
header .search-box input {
    background-color: rgba(255, 255, 255, 0.15) !important;
    border-color: rgba(255, 255, 255, 0.3) !important;
    color: var(--color-white) !important;
}

header .search-box input::placeholder {
    color: rgba(255, 255, 255, 0.7) !important;
}

header .search-box input:focus {
    background-color: var(--color-white) !important;
    color: var(--color-text) !important;
}

/* ============================================
   LEFT SIDEBAR NAVIGATION
   ============================================ */

/* Sidebar background */
.tri-layout-left-contents,
.sidebar {
    background-color: var(--color-bg-light) !important;
}

/* Make sidebar text darker and more readable */
.tri-layout-left,
.tri-layout-left-contents {
    color: #333333 !important;
}

/* Sidebar headings */
.sidebar h5,
.sidebar .h5,
.tri-layout-left h5,
.tri-layout-left .h5 {
    color: var(--color-primary) !important;
    border-bottom: 2px solid var(--color-accent) !important;
    padding-bottom: 0.5rem;
    font-weight: 600 !important;
}

/* Sidebar links */
.sidebar a,
.tri-layout-left a {
    color: var(--color-primary) !important;
}

.sidebar a:hover,
.tri-layout-left a:hover {
    color: var(--color-accent) !important;
    background-color: var(--color-bg-hover) !important;
}

/* Active sidebar item */
.sidebar .active,
.sidebar .selected {
    background-color: var(--color-primary) !important;
    color: var(--color-white) !important;
}

/* ============================================
   RIGHT SIDEBAR (Actions Panel)
   ============================================ */

/* Right sidebar container */
.tri-layout-right,
.tri-layout-right-contents {
    color: #333333 !important;
}

/* Right sidebar headings */
.tri-layout-right h5,
.tri-layout-right .h5 {
    color: var(--color-primary) !important;
    border-bottom: 2px solid var(--color-accent) !important;
    padding-bottom: 0.5rem;
    font-weight: 600 !important;
}

/* Right sidebar actions links */
.tri-layout-right a,
.actions a,
.action-buttons a {
    color: var(--color-primary) !important;
}

.tri-layout-right a:hover,
.actions a:hover,
.action-buttons a:hover {
    color: var(--color-accent) !important;
}

/* Action icons */
.tri-layout-right .svg-icon,
.actions .svg-icon,
.action-buttons .svg-icon {
    color: var(--color-primary) !important;
}

.tri-layout-right a:hover .svg-icon,
.actions a:hover .svg-icon,
.action-buttons a:hover .svg-icon {
    color: var(--color-accent) !important;
}

/* ============================================
   BUTTONS
   ============================================ */

/* Primary buttons */
button.button.primary,
a.button.primary,
.button.primary,
input[type="submit"].primary {
    background-color: var(--color-primary) !important;
    border-color: var(--color-primary) !important;
    color: var(--color-white) !important;
}

button.button.primary:hover,
a.button.primary:hover,
.button.primary:hover,
input[type="submit"].primary:hover {
    background-color: var(--color-primary-dark) !important;
    border-color: var(--color-primary-dark) !important;
}

/* Accent/CTA buttons */
.button.pos,
button.button.pos,
a.button.pos {
    background-color: var(--color-accent) !important;
    border-color: var(--color-accent) !important;
    color: var(--color-primary) !important;
}

.button.pos:hover,
button.button.pos:hover,
a.button.pos:hover {
    background-color: #d4a429 !important;
    border-color: #d4a429 !important;
}

/* Secondary/outline buttons */
.button.outline,
button.button.outline,
a.button.outline {
    border-color: var(--color-primary) !important;
    color: var(--color-primary) !important;
    background-color: transparent !important;
}

.button.outline:hover,
button.button.outline:hover,
a.button.outline:hover {
    background-color: var(--color-primary) !important;
    color: var(--color-white) !important;
}

/* ============================================
   LINKS
   ============================================ */

a {
    color: var(--color-primary);
}

a:hover {
    color: var(--color-primary-dark);
}

/* Breadcrumb links */
.breadcrumbs a {
    color: var(--color-primary) !important;
}

.breadcrumbs a:hover {
    color: var(--color-accent) !important;
}

/* ============================================
   SHELVES, BOOKS, CHAPTERS, PAGES
   ============================================ */

/* Entity list items */
.entity-list-item:hover {
    background-color: var(--color-bg-light) !important;
}

/* Entity icons/colors */
.bookshelf-icon,
.icon-shelf {
    color: var(--color-accent) !important;
}

.book-icon,
.icon-book {
    color: var(--color-primary) !important;
}

.chapter-icon,
.icon-chapter {
    color: #5a8f7b !important;
}

.page-icon,
.icon-page {
    color: var(--color-primary) !important;
}

/* Entity grid cards */
.grid-card {
    border-color: var(--color-border) !important;
}

.grid-card:hover {
    border-color: var(--color-primary) !important;
    box-shadow: 0 2px 8px rgba(0, 38, 59, 0.15) !important;
}

/* Shelf headers */
.shelf-header {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%) !important;
}

/* ============================================
   DROPDOWN MENUS (Light Mode)
   ============================================ */

/* Dropdown container */
[dropdown-menu],
.dropdown-menu,
.popup-body {
    background-color: #ffffff !important;
    border: 1px solid var(--color-border) !important;
    box-shadow: 0 4px 12px rgba(0, 38, 59, 0.15) !important;
}

/* Dropdown items */
[dropdown-menu] a,
.dropdown-menu a,
.popup-body a {
    color: #333333 !important;
}

[dropdown-menu] a:hover,
.dropdown-menu a:hover,
.popup-body a:hover {
    background-color: var(--color-bg-light) !important;
    color: var(--color-primary) !important;
}

/* Dropdown icons */
[dropdown-menu] .svg-icon,
.dropdown-menu .svg-icon,
.popup-body .svg-icon {
    color: #333333 !important;
}

[dropdown-menu] a:hover .svg-icon,
.dropdown-menu a:hover .svg-icon,
.popup-body a:hover .svg-icon {
    color: var(--color-primary) !important;
}

/* ============================================
   USER MENU
   ============================================ */

.user-menu {
    background-color: var(--color-white) !important;
    border-color: var(--color-border) !important;
}

.user-menu a {
    color: #333333 !important;
}

.user-menu a:hover {
    background-color: var(--color-bg-light) !important;
    color: var(--color-primary) !important;
}

/* ============================================
   TAGS
   ============================================ */

.tag-item,
.tag {
    background-color: var(--color-bg-light) !important;
    border: 1px solid var(--color-border) !important;
    color: var(--color-text) !important;
}

.tag-item:hover,
.tag:hover {
    background-color: var(--color-bg-hover) !important;
    border-color: var(--color-primary) !important;
}

/* Status tags - color coding */
.tag-item[data-name="status:approved"],
.tag[data-name="status:approved"] {
    background-color: #d4edda !important;
    border-color: #28a745 !important;
    color: #155724 !important;
}

.tag-item[data-name="status:review"],
.tag[data-name="status:review"] {
    background-color: #fff3cd !important;
    border-color: var(--color-accent) !important;
    color: #856404 !important;
}

.tag-item[data-name="status:draft"],
.tag[data-name="status:draft"] {
    background-color: #e9ecef !important;
    border-color: #6c757d !important;
    color: #495057 !important;
}

.tag-item[data-name="status:archived"],
.tag[data-name="status:archived"] {
    background-color: #f8d7da !important;
    border-color: #dc3545 !important;
    color: #721c24 !important;
}

/* ============================================
   FORMS
   ============================================ */

input[type="text"],
input[type="email"],
input[type="password"],
input[type="search"],
textarea,
select {
    border-color: var(--color-border) !important;
    color: #333333 !important;
}

input[type="text"]:focus,
input[type="email"]:focus,
input[type="password"]:focus,
input[type="search"]:focus,
textarea:focus,
select:focus {
    border-color: var(--color-primary) !important;
    box-shadow: 0 0 0 2px rgba(0, 38, 59, 0.1) !important;
}

input[type="checkbox"]:checked,
input[type="radio"]:checked {
    accent-color: var(--color-primary) !important;
}

/* ============================================
   TABLES
   ============================================ */

table thead {
    background-color: var(--color-primary) !important;
    color: var(--color-white) !important;
}

table thead th {
    color: var(--color-white) !important;
}

table tbody tr:nth-child(even) {
    background-color: var(--color-bg-light) !important;
}

table tbody tr:hover {
    background-color: var(--color-bg-hover) !important;
}

/* ============================================
   ALERTS & NOTIFICATIONS
   ============================================ */

.notification.pos,
.alert.success {
    background-color: #d4edda !important;
    border-color: #28a745 !important;
    color: #155724 !important;
}

.notification.warning,
.alert.warning {
    background-color: #fff3cd !important;
    border-color: var(--color-accent) !important;
    color: #856404 !important;
}

.notification.info,
.alert.info {
    background-color: var(--color-bg-light) !important;
    border-color: var(--color-primary) !important;
    color: var(--color-primary) !important;
}

/* ============================================
   FOOTER
   ============================================ */

footer {
    background-color: var(--color-primary) !important;
    color: var(--color-white) !important;
}

footer a {
    color: var(--color-accent) !important;
}

footer a:hover {
    color: var(--color-white) !important;
}

/* ============================================
   PAGE CONTENT
   ============================================ */

.page-content h1,
.page-content h2,
.page-content h3 {
    color: var(--color-primary) !important;
}

.page-content pre,
.page-content code {
    background-color: var(--color-bg-light) !important;
    border-color: var(--color-border) !important;
}

.page-content blockquote {
    border-left: 4px solid var(--color-accent) !important;
    background-color: var(--color-bg-light) !important;
}

.page-content hr {
    border-color: var(--color-border) !important;
}

/* ============================================
   EDITOR
   ============================================ */

.editor-toolbar {
    background-color: var(--color-bg-light) !important;
    border-color: var(--color-border) !important;
}

.editor-toolbar button:hover {
    background-color: var(--color-primary) !important;
    color: var(--color-white) !important;
}

/* ============================================
   LOGIN PAGE
   ============================================ */

.login-box {
    border: 1px solid var(--color-border) !important;
    box-shadow: 0 4px 12px rgba(0, 38, 59, 0.1) !important;
}

.login-box .primary-background {
    background-color: var(--color-primary) !important;
}

/* ============================================
   MISCELLANEOUS
   ============================================ */

::selection {
    background-color: var(--color-accent) !important;
    color: var(--color-primary) !important;
}

::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--color-bg-light);
}

::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--color-primary);
}

*:focus-visible {
    outline: 2px solid var(--color-accent) !important;
    outline-offset: 2px !important;
}

.loading-container .loading-icon {
    color: var(--color-primary) !important;
}

/* ============================================
   DARK MODE
   ============================================ */

/* Dark mode colors */
:root.dark-mode {
    --color-primary: #4a90c2;
    --color-primary-dark: #00263b;
    --color-accent: #E9B52D;
    --color-text: #e0e0e0;
    --color-text-medium: #c0c0c0;
    --color-text-muted: #a0a0a0;
    --color-bg-dark: #1a1a2e;
    --color-bg-darker: #16162a;
    --color-bg-card: #252540;
    --color-border-dark: #3d3d5c;
}

/* Dark mode body and main containers */
.dark-mode,
.dark-mode body {
    background-color: #1a1a2e !important;
    color: #e0e0e0 !important;
}

.dark-mode .tri-layout-container {
    background-color: #1a1a2e !important;
}

/* Dark mode left sidebar */
.dark-mode .tri-layout-left-contents,
.dark-mode .sidebar {
    background-color: #16162a !important;
    color: #e0e0e0 !important;
}

.dark-mode .tri-layout-left a,
.dark-mode .sidebar a {
    color: #4a90c2 !important;
}

.dark-mode .tri-layout-left a:hover,
.dark-mode .sidebar a:hover {
    color: #E9B52D !important;
    background-color: #252540 !important;
}

.dark-mode .tri-layout-left h5,
.dark-mode .sidebar h5 {
    color: #ffffff !important;
    border-color: #E9B52D !important;
}

/* Dark mode right sidebar */
.dark-mode .tri-layout-right,
.dark-mode .tri-layout-right-contents {
    background-color: #16162a !important;
    color: #e0e0e0 !important;
}

.dark-mode .tri-layout-right a {
    color: #4a90c2 !important;
}

.dark-mode .tri-layout-right a:hover {
    color: #E9B52D !important;
}

.dark-mode .tri-layout-right h5 {
    color: #ffffff !important;
    border-color: #E9B52D !important;
}

/* Dark mode main content area */
.dark-mode .tri-layout-middle {
    background-color: #1a1a2e !important;
}

.dark-mode .tri-layout-middle-contents {
    background-color: #1a1a2e !important;
}

/* Dark mode headings */
.dark-mode h1,
.dark-mode h2,
.dark-mode h3,
.dark-mode h4,
.dark-mode h5 {
    color: #ffffff !important;
}

/* Dark mode entity list items */
.dark-mode .entity-list-item {
    border-color: #3d3d5c !important;
}

.dark-mode .entity-list-item:hover {
    background-color: #252540 !important;
}

.dark-mode .entity-list-item-name {
    color: #ffffff !important;
}

.dark-mode .entity-list-item-description {
    color: #b0b0b0 !important;
}

/* Dark mode book cover colors */
.dark-mode .entity-list-item .entity-image {
    opacity: 0.9;
}

/* Dark mode cards */
.dark-mode .card,
.dark-mode .grid-card {
    background-color: #252540 !important;
    border-color: #3d3d5c !important;
}

.dark-mode .card:hover,
.dark-mode .grid-card:hover {
    border-color: #4a90c2 !important;
}

/* Dark mode dropdown menus */
.dark-mode [dropdown-menu],
.dark-mode .dropdown-menu,
.dark-mode .popup-body {
    background-color: #252540 !important;
    border-color: #3d3d5c !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4) !important;
}

.dark-mode [dropdown-menu] a,
.dark-mode .dropdown-menu a,
.dark-mode .popup-body a {
    color: #e0e0e0 !important;
}

.dark-mode [dropdown-menu] a:hover,
.dark-mode .dropdown-menu a:hover,
.dark-mode .popup-body a:hover {
    background-color: #3d3d5c !important;
    color: #ffffff !important;
}

.dark-mode [dropdown-menu] .svg-icon,
.dark-mode .dropdown-menu .svg-icon {
    color: #e0e0e0 !important;
}

/* Dark mode user menu */
.dark-mode .user-menu {
    background-color: #252540 !important;
    border-color: #3d3d5c !important;
}

.dark-mode .user-menu a {
    color: #e0e0e0 !important;
}

.dark-mode .user-menu a:hover {
    background-color: #3d3d5c !important;
}

/* Dark mode forms */
.dark-mode input[type="text"],
.dark-mode input[type="email"],
.dark-mode input[type="password"],
.dark-mode input[type="search"],
.dark-mode textarea,
.dark-mode select {
    background-color: #252540 !important;
    border-color: #3d3d5c !important;
    color: #e0e0e0 !important;
}

.dark-mode input[type="text"]:focus,
.dark-mode input[type="email"]:focus,
.dark-mode input[type="password"]:focus,
.dark-mode input[type="search"]:focus,
.dark-mode textarea:focus,
.dark-mode select:focus {
    border-color: #4a90c2 !important;
    box-shadow: 0 0 0 2px rgba(74, 144, 194, 0.2) !important;
}

/* Dark mode tables */
.dark-mode table {
    background-color: #252540 !important;
}

.dark-mode table thead {
    background-color: #00263b !important;
}

.dark-mode table tbody tr {
    background-color: #252540 !important;
}

.dark-mode table tbody tr:nth-child(even) {
    background-color: #1a1a2e !important;
}

.dark-mode table tbody tr:hover {
    background-color: #3d3d5c !important;
}

.dark-mode table td,
.dark-mode table th {
    border-color: #3d3d5c !important;
}

/* Dark mode tags */
.dark-mode .tag-item,
.dark-mode .tag {
    background-color: #252540 !important;
    border-color: #3d3d5c !important;
    color: #e0e0e0 !important;
}

/* Dark mode code blocks */
.dark-mode .page-content pre,
.dark-mode .page-content code {
    background-color: #16162a !important;
    border-color: #3d3d5c !important;
    color: #e0e0e0 !important;
}

/* Dark mode blockquotes */
.dark-mode .page-content blockquote {
    background-color: #252540 !important;
    border-color: #E9B52D !important;
}

/* Dark mode scrollbar */
.dark-mode ::-webkit-scrollbar-track {
    background: #16162a;
}

.dark-mode ::-webkit-scrollbar-thumb {
    background: #3d3d5c;
}

.dark-mode ::-webkit-scrollbar-thumb:hover {
    background: #4a90c2;
}

/* Dark mode buttons */
.dark-mode .button.outline {
    border-color: #4a90c2 !important;
    color: #4a90c2 !important;
}

.dark-mode .button.outline:hover {
    background-color: #4a90c2 !important;
    color: #ffffff !important;
}

/* Dark mode muted text */
.dark-mode .text-muted,
.dark-mode .meta,
.dark-mode small {
    color: #a0a0a0 !important;
}

/* Dark mode links */
.dark-mode a {
    color: #4a90c2;
}

.dark-mode a:hover {
    color: #E9B52D;
}

/* Dark mode breadcrumbs */
.dark-mode .breadcrumbs a {
    color: #4a90c2 !important;
}

.dark-mode .breadcrumbs a:hover {
    color: #E9B52D !important;
}

/* Dark mode editor */
.dark-mode .editor-toolbar {
    background-color: #252540 !important;
    border-color: #3d3d5c !important;
}

.dark-mode .editor-toolbar button {
    color: #e0e0e0 !important;
}

.dark-mode .editor-toolbar button:hover {
    background-color: #4a90c2 !important;
}

/* ============================================
   ADMIN BANNER
   ============================================ */

#admin-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 32px;
    background: linear-gradient(90deg, #1a1a2e 0%, #00263b 100%);
    border-bottom: 2px solid #E9B52D;
    color: #ffffff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    font-size: 13px;
    font-weight: 500;
    z-index: 9999;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.admin-banner-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

.admin-banner-left span:last-child::before {
    content: "\2699";
    margin-right: 6px;
    color: #E9B52D;
}

/* Connection status indicator - always visible */
#cg-status {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
    flex-shrink: 0;
}

#cg-status.cg-checking {
    background: #888;
    animation: pulse 1.5s infinite;
}

#cg-status.cg-connected {
    background: #4ade80;
    box-shadow: 0 0 6px #4ade80;
}

#cg-status.cg-disconnected {
    background: #f87171;
    box-shadow: 0 0 6px #f87171;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Navigation links */
#admin-banner-nav {
    display: flex;
    gap: 4px;
}

#admin-banner-nav a {
    color: #ffffff;
    text-decoration: none;
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 4px;
    transition: background 0.2s;
}

#admin-banner-nav a:hover {
    background: rgba(233, 181, 45, 0.25);
    color: #E9B52D;
}

/* ============================================
   ADMIN BANNER LAYOUT ADJUSTMENTS
   ============================================
   These styles require the CSS :has() selector to detect when
   #admin-banner is present in the DOM and adjust layout accordingly.

   Styles that depend on :has():
   - body:has(#admin-banner) - padding/margin reset
   - body:has(#admin-banner) header#header - fixed positioning below banner
   - body:has(#admin-banner) #content - margin-top to clear banner+header
   - body:has(#admin-banner) .setting-list, .container, etc. - margin reset
   - body:has(#admin-banner) .tri-layout-container, .content-wrap - gap fix
   - body:has(#admin-banner) header#header::before - background fill
   - body:has(#admin-banner) editor toolbars - sticky top offset (110px)
   - body:has(#admin-banner) editor headers - sticky positioning
   - body:has(#admin-banner) editor content areas - padding/margin reset
   - body:has(#admin-banner) .toolbar.page-edit-toolbar - relative position

   For browsers without :has() support, a JS fallback adds the class
   .has-admin-banner to <body> when #admin-banner is detected.
   ============================================ */

/* Fallback for browsers without :has() support.
   The .has-admin-banner class is added via JavaScript (see <script> section). */
@supports not selector(:has(*)) {
    body.has-admin-banner {
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    body.has-admin-banner header#header {
        position: fixed !important;
        top: 34px !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        margin-top: 0 !important;
        z-index: 9998 !important;
    }

    body.has-admin-banner #content {
        margin-top: 110px !important;
    }

    body.has-admin-banner .setting-list,
    body.has-admin-banner .container,
    body.has-admin-banner .card.content-wrap,
    body.has-admin-banner [class*="settings"] {
        margin-top: 0 !important;
    }

    body.has-admin-banner .tri-layout-container,
    body.has-admin-banner .content-wrap {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }

    body.has-admin-banner header#header::before {
        content: '';
        position: absolute;
        top: -34px;
        left: 0;
        right: 0;
        height: 34px;
        background: linear-gradient(90deg, #1a1a2e 0%, #00263b 100%);
        z-index: -1;
    }

    body.has-admin-banner .editor-toolbar-main,
    body.has-admin-banner .floating-toolbox,
    body.has-admin-banner .editor-container .sticky,
    body.has-admin-banner .page-editor .sticky,
    body.has-admin-banner .toolbox,
    body.has-admin-banner .form-group.collapsible,
    body.has-admin-banner .edit-area > .sticky,
    body.has-admin-banner [sticky-container],
    body.has-admin-banner .sticky-top-controller {
        top: 110px !important;
    }

    body.has-admin-banner .primary-background-light.sticky-top-controller,
    body.has-admin-banner .form-group.sticky,
    body.has-admin-banner .editor-toolbar,
    body.has-admin-banner .mce-toolbar-grp,
    body.has-admin-banner .tox-toolbar-overlord,
    body.has-admin-banner .tox-editor-header {
        top: 110px !important;
        margin-top: 0 !important;
    }

    body.has-admin-banner .setting-list > .sticky,
    body.has-admin-banner .content-wrap .sticky {
        top: 110px !important;
    }

    body.has-admin-banner .edit-header,
    body.has-admin-banner .page-edit-header,
    body.has-admin-banner .editor-header,
    body.has-admin-banner .content-wrap > .primary-background-light,
    body.has-admin-banner .faded-small.primary-background-light,
    body.has-admin-banner [class*="edit"] > .primary-background-light:first-child,
    body.has-admin-banner .page-editor > div:first-child,
    body.has-admin-banner form > .primary-background-light:first-child {
        position: sticky !important;
        top: 110px !important;
        z-index: 100 !important;
        margin-top: 0 !important;
    }

    body.has-admin-banner .page-editor,
    body.has-admin-banner .chapter-editor,
    body.has-admin-banner .book-editor,
    body.has-admin-banner [class*="-edit"],
    body.has-admin-banner .edit-content {
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    body.has-admin-banner .toolbar.page-edit-toolbar {
        position: relative !important;
        top: auto !important;
        z-index: 100 !important;
    }
}

/* Modern browsers with :has() support */
@supports selector(:has(*)) {
    /* Push main content down when banner is present */
    body:has(#admin-banner) {
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    body:has(#admin-banner) header#header {
        position: fixed !important;
        top: 34px !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        margin-top: 0 !important;
        z-index: 9998 !important;
    }

    /* Main content wrapper needs to clear fixed header + banner */
    body:has(#admin-banner) #content {
        margin-top: 110px !important;  /* 34px banner + ~56px header + 20px buffer */
    }

    /* Settings and other admin pages - ensure content clears fixed header */
    body:has(#admin-banner) .setting-list,
    body:has(#admin-banner) .container,
    body:has(#admin-banner) .card.content-wrap,
    body:has(#admin-banner) [class*="settings"] {
        margin-top: 0 !important;
    }

    /* Fix gap between banner and content */
    body:has(#admin-banner) .tri-layout-container,
    body:has(#admin-banner) .content-wrap {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }

    /* Ensure header background doesn't have gap */
    body:has(#admin-banner) header#header::before {
        content: '';
        position: absolute;
        top: -34px;
        left: 0;
        right: 0;
        height: 34px;
        background: linear-gradient(90deg, #1a1a2e 0%, #00263b 100%);
        z-index: -1;
    }

    /* Editor toolbar adjustments - push down sticky elements */
    body:has(#admin-banner) .editor-toolbar-main,
    body:has(#admin-banner) .floating-toolbox,
    body:has(#admin-banner) .editor-container .sticky,
    body:has(#admin-banner) .page-editor .sticky,
    body:has(#admin-banner) .toolbox,
    body:has(#admin-banner) .form-group.collapsible,
    body:has(#admin-banner) .edit-area > .sticky,
    body:has(#admin-banner) [sticky-container],
    body:has(#admin-banner) .sticky-top-controller {
        top: 110px !important;
    }

    /* Primary form actions (Save/Cancel buttons) - sticky elements only */
    body:has(#admin-banner) .primary-background-light.sticky-top-controller,
    body:has(#admin-banner) .form-group.sticky,
    body:has(#admin-banner) .editor-toolbar,
    body:has(#admin-banner) .mce-toolbar-grp,
    body:has(#admin-banner) .tox-toolbar-overlord,
    body:has(#admin-banner) .tox-editor-header {
        top: 110px !important;
        margin-top: 0 !important;
    }

    /* Chapter/Book edit forms */
    body:has(#admin-banner) .setting-list > .sticky,
    body:has(#admin-banner) .content-wrap .sticky {
        top: 110px !important;
    }

    /* Page/Chapter editor - header with save button */
    body:has(#admin-banner) .edit-header,
    body:has(#admin-banner) .page-edit-header,
    body:has(#admin-banner) .editor-header,
    body:has(#admin-banner) .content-wrap > .primary-background-light,
    body:has(#admin-banner) .faded-small.primary-background-light,
    body:has(#admin-banner) [class*="edit"] > .primary-background-light:first-child,
    body:has(#admin-banner) .page-editor > div:first-child,
    body:has(#admin-banner) form > .primary-background-light:first-child {
        position: sticky !important;
        top: 110px !important;
        z-index: 100 !important;
        margin-top: 0 !important;
    }

    /* Ensure the entire page content area accounts for headers */
    body:has(#admin-banner) .page-editor,
    body:has(#admin-banner) .chapter-editor,
    body:has(#admin-banner) .book-editor,
    body:has(#admin-banner) [class*="-edit"],
    body:has(#admin-banner) .edit-content {
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    /* Page editor toolbar (Back/Draft/Save buttons) - not sticky, flows with content */
    body:has(#admin-banner) .toolbar.page-edit-toolbar {
        position: relative !important;
        top: auto !important;
        z-index: 100 !important;
    }
}

/* Banner action buttons (Flag, Convert) */
.admin-banner-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    padding: 0 12px;
    border-left: 1px solid rgba(255, 255, 255, 0.2);
    border-right: 1px solid rgba(255, 255, 255, 0.2);
    margin: 0 8px;
}

.admin-banner-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #ffffff;
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
}

.admin-banner-btn:hover {
    background: rgba(233, 181, 45, 0.25);
    border-color: #E9B52D;
    color: #E9B52D;
}

.admin-banner-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.admin-banner-btn.active {
    background: rgba(74, 222, 128, 0.2);
    border-color: #4ade80;
    color: #4ade80;
}

/* Review Queue Dropdown */
.review-queue-container {
    position: relative;
    display: inline-flex;
}

.review-queue-btn {
    position: relative;
    /* Match nav link styling */
    background: transparent !important;
    border: none !important;
    color: #ffffff;
    font-size: 12px;
    font-weight: 500;
    padding: 4px 10px;
    cursor: pointer;
}

.review-queue-btn:hover {
    background: rgba(233, 181, 45, 0.25) !important;
    color: #E9B52D;
}

.review-queue-badge {
    position: absolute;
    bottom: -6px;
    right: -6px;
    background: #f87171;
    color: white;
    font-size: 10px;
    font-weight: 600;
    min-width: 16px;
    height: 16px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
}

.review-queue-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 8px;
    background: #252540;
    border: 1px solid #3d3d5c;
    border-radius: 8px;
    min-width: 320px;
    max-height: 400px;
    overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    z-index: 10000;
    display: none;
}

.review-queue-dropdown.open {
    display: block;
}

.review-queue-header {
    padding: 12px 16px;
    border-bottom: 1px solid #3d3d5c;
    font-weight: 600;
    color: #ffffff;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.review-queue-empty {
    padding: 24px 16px;
    text-align: center;
    color: #a0a0a0;
}

.review-queue-item {
    padding: 10px 16px;
    border-bottom: 1px solid rgba(61, 61, 92, 0.5);
    cursor: pointer;
    transition: background 0.2s;
}

.review-queue-item:hover {
    background: rgba(74, 144, 194, 0.15);
}

.review-queue-item:last-child {
    border-bottom: none;
}

.review-queue-item-title {
    color: #ffffff;
    font-size: 13px;
    margin-bottom: 4px;
}

.review-queue-item-meta {
    color: #a0a0a0;
    font-size: 11px;
}

/* Conversion button styles */
.admin-banner-btn.convert-btn {
    background: rgba(139, 92, 246, 0.2);
    border-color: #8b5cf6;
    color: #c4b5fd;
}

.admin-banner-btn.convert-btn:hover {
    background: rgba(139, 92, 246, 0.35);
    color: #ffffff;
}

/* Modal for conversion dialog */
.admin-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
}

.admin-modal {
    background: #252540;
    border: 1px solid #3d3d5c;
    border-radius: 12px;
    padding: 24px;
    min-width: 400px;
    max-width: 500px;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
}

.admin-modal-title {
    color: #ffffff;
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 16px;
}

.admin-modal-body {
    color: #e0e0e0;
    margin-bottom: 20px;
}

.admin-modal-select {
    width: 100%;
    padding: 10px 12px;
    background: #1a1a2e;
    border: 1px solid #3d3d5c;
    border-radius: 6px;
    color: #e0e0e0;
    font-size: 14px;
    margin-bottom: 16px;
}

.admin-modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.admin-modal-btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
}

.admin-modal-btn.cancel {
    background: transparent;
    border: 1px solid #3d3d5c;
    color: #a0a0a0;
}

.admin-modal-btn.cancel:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #ffffff;
}

.admin-modal-btn.confirm {
    background: #4a90c2;
    color: #ffffff;
}

.admin-modal-btn.confirm:hover {
    background: #5ca0d2;
}

/* Toast notification */
.admin-toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: #252540;
    border: 1px solid #3d3d5c;
    border-radius: 8px;
    padding: 12px 20px;
    color: #e0e0e0;
    font-size: 14px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    z-index: 10002;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
}

.admin-toast.show {
    transform: translateY(0);
    opacity: 1;
}

.admin-toast.success {
    border-color: #4ade80;
    background: rgba(74, 222, 128, 0.15);
}

.admin-toast.error {
    border-color: #f87171;
    background: rgba(248, 113, 113, 0.15);
}

/* Dark mode adjustments */
.dark-mode #admin-banner {
    background: linear-gradient(90deg, #0d0d1a 0%, #1a1a2e 100%);
}
</style>
<script>
/* :has() CSS selector fallback - adds .has-admin-banner class to body
   for browsers that do not support :has(). This enables the @supports not
   selector(:has(*)) CSS rules to apply correctly. */
(function() {
    if (!CSS.supports('selector(:has(*))')) {
        function applyBannerClass() {
            if (document.getElementById('admin-banner')) {
                document.body.classList.add('has-admin-banner');
            }
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', applyBannerClass);
        } else {
            applyBannerClass();
        }
        // Also observe for dynamically added banner
        var observer = new MutationObserver(function() {
            if (document.getElementById('admin-banner')) {
                document.body.classList.add('has-admin-banner');
            } else {
                document.body.classList.remove('has-admin-banner');
            }
        });
        observer.observe(document.documentElement, { childList: true, subtree: true });
    }
})();

(function() {
    // Content Generator URL and API token for proxy requests
    // Token is injected via <meta name="cg-token"> tag (set in BookStack HEAD_CONTENT .env)
    var CG_URL = 'https://content-generator.lceic.com';
    var CG_TOKEN = document.querySelector('meta[name="cg-token"]')?.getAttribute('content') || '';
    var connectionOk = false;
    var reviewQueueOpen = false;
    var reviewQueue = [];
    var pageId = null;
    var entityType = null;
    var entityId = null;
    var isPageFlagged = false;

    // Helper to add token to URL
    function apiUrl(path) {
        var sep = path.indexOf('?') >= 0 ? '&' : '?';
        return CG_URL + path + sep + 'token=' + CG_TOKEN;
    }

    // Check if user is admin by looking for settings link (only visible to admins)
    function isAdmin() {
        return !!document.querySelector('a[href*="/settings"]');
    }

    // Check if user is logged in - multiple detection methods
    function isLoggedIn() {
        // Method 1: logout link
        if (document.querySelector('a[href*="/logout"]')) return true;
        // Method 2: user menu / profile link
        if (document.querySelector('a[href*="/user/"], .user-name, [href*="preferences"]')) return true;
        // Method 3: if admin, definitely logged in
        if (isAdmin()) return true;
        // Method 4: edit buttons (only shown to logged in users)
        if (document.querySelector('a[href*="/edit"]')) return true;
        return false;
    }

    // Show toast notification
    function showToast(message, type) {
        var existing = document.querySelector('.admin-toast');
        if (existing) existing.remove();

        var toast = document.createElement('div');
        toast.className = 'admin-toast ' + (type || '');
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(function() { toast.classList.add('show'); }, 10);
        setTimeout(function() {
            toast.classList.remove('show');
            setTimeout(function() { toast.remove(); }, 300);
        }, 3000);
    }

    // Check content-generator health
    function checkConnection() {
        fetch(CG_URL + '/health', { method: 'GET', mode: 'cors' })
            .then(function(r) {
                connectionOk = r.ok;
                updateStatus();
            })
            .catch(function() {
                connectionOk = false;
                updateStatus();
            });
    }

    function updateStatus() {
        var indicator = document.getElementById('cg-status');
        if (indicator) {
            indicator.className = connectionOk ? 'cg-connected' : 'cg-disconnected';
            indicator.title = connectionOk
                ? 'Content Generator: Connected'
                : 'Content Generator: Disconnected (Cloudflare Access may be blocking)';
        }
    }

    // Extract page context from URL
    function getPageContext() {
        var path = window.location.pathname;
        var match;

        if ((match = path.match(/\/books\/([^/]+)\/page\/([^/]+)/))) {
            return { type: 'page', bookSlug: match[1], pageSlug: match[2] };
        }
        if ((match = path.match(/\/books\/([^/]+)\/chapter\/([^/]+)/))) {
            return { type: 'chapter', bookSlug: match[1], chapterSlug: match[2] };
        }
        if ((match = path.match(/\/books\/([^/]+)$/))) {
            return { type: 'book', bookSlug: match[1] };
        }
        if ((match = path.match(/\/shelves\/([^/]+)/))) {
            return { type: 'shelf', shelfSlug: match[1] };
        }
        return null;
    }

    // Resolve entity ID via proxy API
    function resolveCurrentPage(callback) {
        var url = window.location.href;
        var apiEndpoint = apiUrl('/api/proxy/resolve-url?url=' + encodeURIComponent(url));
        console.log('[Banner] Resolving URL:', url);
        console.log('[Banner] API endpoint:', apiEndpoint);
        fetch(apiEndpoint)
        .then(function(r) {
            console.log('[Banner] Response status:', r.status);
            return r.json();
        })
        .then(function(data) {
            console.log('[Banner] Resolved data:', data);
            if (data.type && data.id) {
                callback(data.type, data.id, data.details);
            } else {
                console.log('[Banner] No type/id in response');
                callback(null, null, null);
            }
        })
        .catch(function(err) {
            console.error('[Banner] Could not resolve page:', err);
            callback(null, null, null);
        });
    }

    // Toggle flag for review (add or remove)
    function flagForReview() {
        if (!pageId) {
            showToast('Could not determine page ID', 'error');
            return;
        }

        var btn = document.getElementById('flag-review-btn');
        if (btn) btn.disabled = true;

        if (isPageFlagged) {
            // Remove the flag
            fetch(apiUrl('/api/proxy/pages/' + pageId + '/remove-tag'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: 'review-requested' })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    showToast('Review flag removed', 'success');
                    isPageFlagged = false;
                    if (btn) {
                        btn.classList.remove('active');
                        btn.textContent = 'Flag for Review';
                        btn.disabled = false;
                    }
                    // Refresh review queue
                    loadReviewQueue();
                } else {
                    throw new Error(data.error || 'Failed to remove flag');
                }
            })
            .catch(function(err) {
                showToast(err.message || 'Failed to remove flag', 'error');
                if (btn) btn.disabled = false;
            });
        } else {
            // Add the flag
            fetch(apiUrl('/api/proxy/pages/' + pageId + '/add-tag'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: 'review-requested', value: new Date().toISOString().split('T')[0] })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    showToast('Page flagged for review', 'success');
                    isPageFlagged = true;
                    if (btn) {
                        btn.classList.add('active');
                        btn.textContent = 'âœ“ Flagged';
                        btn.disabled = false;
                    }
                    // Refresh review queue
                    loadReviewQueue();
                } else {
                    throw new Error(data.error || 'Failed to flag page');
                }
            })
            .catch(function(err) {
                showToast(err.message || 'Failed to flag page', 'error');
                if (btn) btn.disabled = false;
            });
        }
    }

    // Load review queue
    function loadReviewQueue() {
        fetch(apiUrl('/api/proxy/search?tag=review-requested'))
        .then(function(r) { return r.json(); })
        .then(function(data) {
            reviewQueue = data.pages || [];
            updateReviewQueueBadge();
            if (reviewQueueOpen) renderReviewQueue();
        })
        .catch(function(err) {
            console.error('Failed to load review queue:', err);
        });
    }

    // Update badge count
    function updateReviewQueueBadge() {
        var badge = document.getElementById('review-queue-badge');
        if (badge) {
            badge.textContent = reviewQueue.length;
            badge.style.display = reviewQueue.length > 0 ? 'flex' : 'none';
        }
    }

    // Toggle review queue dropdown
    function toggleReviewQueue() {
        reviewQueueOpen = !reviewQueueOpen;
        var dropdown = document.getElementById('review-queue-dropdown');
        if (dropdown) {
            dropdown.classList.toggle('open', reviewQueueOpen);
            if (reviewQueueOpen) {
                loadReviewQueue();
                renderReviewQueue();
            }
        }
    }

    // Render review queue items
    function renderReviewQueue() {
        var list = document.getElementById('review-queue-list');
        if (!list) return;

        if (reviewQueue.length === 0) {
            list.innerHTML = '<div class="review-queue-empty">No pages flagged for review</div>';
            return;
        }

        list.innerHTML = reviewQueue.map(function(page) {
            return '<div class="review-queue-item" data-url="' + page.url + '">' +
                '<div class="review-queue-item-title">' + escapeHtml(page.name) + '</div>' +
                '<div class="review-queue-item-meta">' +
                    (page.book ? page.book.name : '') +
                    (page.chapter ? ' / ' + page.chapter.name : '') +
                '</div>' +
            '</div>';
        }).join('');

        // Add click handlers
        list.querySelectorAll('.review-queue-item').forEach(function(item) {
            item.addEventListener('click', function() {
                window.location.href = item.dataset.url;
            });
        });
    }

    // Convert chapter to book
    function convertChapterToBook() {
        if (!entityId || entityType !== 'chapter') {
            showToast('Not on a chapter page', 'error');
            return;
        }

        if (!confirm('Convert this chapter to a book? All pages will be moved to the new book.')) {
            return;
        }

        showToast('Converting chapter to book...', '');

        fetch(apiUrl('/api/proxy/chapters/' + entityId + '/to-book'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                showToast('Chapter converted to book: ' + data.newBook.name, 'success');
                setTimeout(function() {
                    window.location.href = '/books/' + data.newBook.slug;
                }, 1500);
            } else {
                throw new Error(data.error || 'Failed to convert');
            }
        })
        .catch(function(err) {
            showToast(err.message || 'Failed to convert chapter', 'error');
        });
    }

    // Convert book to chapter - show modal
    function convertBookToChapter() {
        if (!entityId || entityType !== 'book') {
            showToast('Not on a book page', 'error');
            return;
        }

        // First, load list of books for dropdown
        fetch(apiUrl('/api/proxy/books'))
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var books = (data.books || []).filter(function(b) { return b.id !== entityId; });
            showBookSelectorModal(books);
        })
        .catch(function(err) {
            showToast('Failed to load books', 'error');
        });
    }

    // Show modal to select target book
    function showBookSelectorModal(books) {
        var overlay = document.createElement('div');
        overlay.className = 'admin-modal-overlay';
        overlay.innerHTML =
            '<div class="admin-modal">' +
                '<div class="admin-modal-title">Convert Book to Chapter</div>' +
                '<div class="admin-modal-body">' +
                    '<p style="margin-bottom: 12px;">Select the target book where this book will become a chapter:</p>' +
                    '<select id="target-book-select" class="admin-modal-select">' +
                        '<option value="">Select a book...</option>' +
                        books.map(function(b) {
                            return '<option value="' + b.id + '">' + escapeHtml(b.name) + ' (' + escapeHtml(b.shelfName) + ')</option>';
                        }).join('') +
                    '</select>' +
                '</div>' +
                '<div class="admin-modal-actions">' +
                    '<button class="admin-modal-btn cancel">Cancel</button>' +
                    '<button class="admin-modal-btn confirm">Convert</button>' +
                '</div>' +
            '</div>';

        document.body.appendChild(overlay);

        // Event handlers
        overlay.querySelector('.cancel').addEventListener('click', function() {
            overlay.remove();
        });

        overlay.querySelector('.confirm').addEventListener('click', function() {
            var targetBookId = document.getElementById('target-book-select').value;
            if (!targetBookId) {
                showToast('Please select a target book', 'error');
                return;
            }
            overlay.remove();
            performBookToChapterConversion(parseInt(targetBookId, 10));
        });

        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) overlay.remove();
        });
    }

    // Perform book to chapter conversion
    function performBookToChapterConversion(targetBookId) {
        showToast('Converting book to chapter...', '');

        fetch(apiUrl('/api/proxy/books/' + entityId + '/to-chapter'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ targetBookId: targetBookId })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                showToast('Book converted to chapter', 'success');
                setTimeout(function() {
                    window.location.href = '/books/' + data.newChapter.slug.split('/')[0] + '/chapter/' + data.newChapter.slug;
                }, 1500);
            } else {
                throw new Error(data.error || 'Failed to convert');
            }
        })
        .catch(function(err) {
            showToast(err.message || 'Failed to convert book', 'error');
        });
    }

    // Escape HTML
    function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (reviewQueueOpen && !e.target.closest('.review-queue-container')) {
            reviewQueueOpen = false;
            var dropdown = document.getElementById('review-queue-dropdown');
            if (dropdown) dropdown.classList.remove('open');
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        var ctx = getPageContext();
        entityType = ctx ? ctx.type : null;

        // Create initial banner structure (IDs will be resolved async)
        createBanner(ctx, null);

        // Resolve entity ID via API for pages/chapters/books
        if (ctx && (ctx.type === 'page' || ctx.type === 'chapter' || ctx.type === 'book')) {
            resolveCurrentPage(function(type, id, details) {
                if (type === 'page') {
                    pageId = id;
                    // Check if page already has review-requested tag
                    var alreadyFlagged = false;
                    if (details && details.tags) {
                        alreadyFlagged = details.tags.some(function(t) {
                            return t.name === 'review-requested';
                        });
                    }
                    // Update flag button now that we have the ID
                    updateFlagButton(alreadyFlagged);
                } else if (type === 'chapter' || type === 'book') {
                    entityId = id;
                    entityType = type;
                    // Update convert button
                    updateConvertButton(type);
                }
            });
        }

        // Check connection status
        checkConnection();
        setInterval(checkConnection, 60000);

        // Load review queue for admins
        if (isAdmin()) {
            loadReviewQueue();
        }
    });

    function createBanner(ctx, resolvedId) {
        // Only show banner for logged-in users
        if (!isLoggedIn()) return;

        var pageUrl = encodeURIComponent(window.location.href);
        var isAdminUser = isAdmin();

        // For non-admins on pages, show minimal banner with just flag button
        if (!isAdminUser) {
            if (ctx && ctx.type === 'page') {
                var miniBanner = document.createElement('div');
                miniBanner.id = 'admin-banner';
                miniBanner.style.justifyContent = 'flex-end';
                miniBanner.innerHTML = '<nav id="admin-banner-nav">' +
                    '<button id="flag-review-btn" class="review-queue-btn" title="Flag this page for admin review" disabled style="opacity:0.5">Flag for Review</button>' +
                '</nav>';
                document.body.insertBefore(miniBanner, document.body.firstChild);

                // Attach event listener (CSP-safe)
                var flagBtn = document.getElementById('flag-review-btn');
                if (flagBtn) {
                    flagBtn.addEventListener('click', function() {
                        flagForReview();
                    });
                }
            }
            return;
        }


        // Admin view - full banner
        var actions = '';
        // Default enrichment settings
        var enrichModel = 'google/gemini-3-flash-preview';
        var enrichGuidance = encodeURIComponent('Review content and correct errors if observed. Otherwise add detail and expand the content while maintaining the existing organization and styles of the page.');
        if (ctx) {
            if (ctx.type === 'page') {
                actions += '<a href="' + CG_URL + '/enrich?url=' + pageUrl + '&model=' + enrichModel + '&guidance=' + enrichGuidance + '&autostart=true" target="_blank" title="Enrich this page with AI">Enrich</a>';
                actions += '<a href="' + CG_URL + '/organize?url=' + pageUrl + '&autostart=true" target="_blank" title="Reorganize this page">Organize</a>';
            } else if (ctx.type === 'chapter' || ctx.type === 'book') {
                actions += '<a href="' + CG_URL + '/enrich?url=' + pageUrl + '" target="_blank" title="View enrichment options">Enrich</a>';
            }
        }

        // Flag button (for pages) - styled as nav link, placed before review queue
        var flagButtonHtml = '';
        if (ctx && ctx.type === 'page') {
            flagButtonHtml = '<button id="flag-review-btn" class="review-queue-btn" title="Flag this page for admin review" disabled style="opacity:0.5">Flag for Review</button>';
        }

        // Review queue (admin only)
        var reviewQueueHtml = '<div class="review-queue-container">' +
            '<button id="review-queue-toggle" class="review-queue-btn">' +
                'Review Queue' +
                '<span id="review-queue-badge" class="review-queue-badge" style="display:none">0</span>' +
            '</button>' +
            '<div id="review-queue-dropdown" class="review-queue-dropdown">' +
                '<div class="review-queue-header">' +
                    '<span>Pages Flagged for Review</span>' +
                    '<button id="review-queue-refresh" style="background:none;border:none;color:#4a90c2;cursor:pointer;font-size:12px;">Refresh</button>' +
                '</div>' +
                '<div id="review-queue-list"></div>' +
            '</div>' +
        '</div>';

        // Build actions section - only for convert buttons (chapter/book)
        var actionSection = '';
        if (ctx && (ctx.type === 'chapter' || ctx.type === 'book')) {
            actionSection = '<div id="banner-actions" class="admin-banner-actions">';
            if (ctx.type === 'chapter') {
                actionSection += '<button id="convert-btn" class="admin-banner-btn convert-btn" title="Convert this chapter to a standalone book" disabled>â†’ Book</button>';
            } else if (ctx.type === 'book') {
                actionSection += '<button id="convert-btn" class="admin-banner-btn convert-btn" title="Convert this book to a chapter in another book" disabled>â†’ Chapter</button>';
            }
            actionSection += '</div>';
        }

        // Build banner HTML
        var banner = document.createElement('div');
        banner.id = 'admin-banner';
        banner.innerHTML =
            '<div class="admin-banner-left">' +
                '<span id="cg-status" class="cg-checking" title="Checking connection..."></span>' +
                '<span>Admin</span>' +
            '</div>' +
            actionSection +
            '<nav id="admin-banner-nav">' +
                actions +
                flagButtonHtml +
                reviewQueueHtml +
                '<a href="' + CG_URL + '/health" target="_blank" title="Content health dashboard">Health</a>' +
                '<a href="' + CG_URL + '/costs" target="_blank" title="API cost tracking">Costs</a>' +
                '<a href="' + CG_URL + '" target="_blank" title="Content Generator">Generator</a>' +
            '</nav>';

        document.body.insertBefore(banner, document.body.firstChild);

        // Attach event listeners (CSP-safe, no inline onclick)
        attachBannerEventListeners(ctx);
    }

    function attachBannerEventListeners(ctx) {
        // Flag button
        var flagBtn = document.getElementById('flag-review-btn');
        if (flagBtn) {
            flagBtn.addEventListener('click', function() {
                flagForReview();
            });
        }

        // Review queue toggle
        var reviewToggle = document.getElementById('review-queue-toggle');
        if (reviewToggle) {
            reviewToggle.addEventListener('click', function() {
                toggleReviewQueue();
            });
        }

        // Review queue refresh
        var refreshBtn = document.getElementById('review-queue-refresh');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                loadReviewQueue();
            });
        }

        // Convert button
        var convertBtn = document.getElementById('convert-btn');
        if (convertBtn && ctx) {
            if (ctx.type === 'chapter') {
                convertBtn.addEventListener('click', function() {
                    convertChapterToBook();
                });
            } else if (ctx.type === 'book') {
                convertBtn.addEventListener('click', function() {
                    convertBookToChapter();
                });
            }
        }
    }

    function updateFlagButton(alreadyFlagged) {
        var btn = document.getElementById('flag-review-btn');
        console.log('[Banner] updateFlagButton called, pageId:', pageId, 'btn:', btn, 'alreadyFlagged:', alreadyFlagged);
        if (btn && pageId) {
            btn.disabled = false;
            btn.style.opacity = '1';
            console.log('[Banner] Flag button enabled');

            // Track and display flagged state
            isPageFlagged = alreadyFlagged;
            if (alreadyFlagged) {
                btn.classList.add('active');
                btn.textContent = 'âœ“ Flagged';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'Flag for Review';
            }
        }
    }

    function updateConvertButton(type) {
        var btn = document.getElementById('convert-btn');
        if (btn && entityId) {
            btn.disabled = false;
        }
    }

    // Expose functions globally for onclick handlers
    window.flagForReview = flagForReview;
    window.toggleReviewQueue = toggleReviewQueue;
    window.loadReviewQueue = loadReviewQueue;
    window.convertChapterToBook = convertChapterToBook;
    window.convertBookToChapter = convertBookToChapter;
})();
</script>
